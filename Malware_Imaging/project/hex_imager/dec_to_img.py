# Standard Library Imports
import io
import os
import sys

# Conda Imports
import numpy as np
import cv2 as cv

# Project Defined Imports
from Malware_Imaging.config import DATA_DIRECTORIES, IMAGE_DIRECTORIES, get_image_width


def dec_to_img():

    # Declaring Imgae Widths, and FILE SIZE for Each File
    FILE_SIZE = [
        os.path.getsize(file) * 0.001 for file in DATA_DIRECTORIES["DEC_FILES"]
    ]
    TOTAL_SIZE = sum(FILE_SIZE)
    IMAGE_WIDTH = [get_image_width(size) for size in FILE_SIZE]

    # Initializing completed to display how far along the process is going
    # And printing to the user to let them know it has begun.
    completed = 0
    print("Converting Decimal Files to Images")

    # The loop has zip to make sure that all variables are in step
    # Size helps keep track of how far along, width help create the neccessary
    # array for the image sizing, File is the orignal hex dump,
    # and path is where the image will be saved.
    # A lot of these paths and values have been preprocessed in config
    for size, width, file, path in zip(
        FILE_SIZE,
        IMAGE_WIDTH,
        DATA_DIRECTORIES["DEC_FILES"],
        IMAGE_DIRECTORIES["MALWARE_DEC_IMAGES_PATHS"],
    ):
        # Vector is initialized to be empty as we read all values in,
        # This one dimensioal vector is easier to convert into the
        # 2d numpy array
        vector = []
        with io.open(file, mode="r") as f:
            for line in f:
                vector.extend([digit for digit in line.split()])
            # The padding is to make sure that numpy can convert this
            # list into the propper 2d array
            # any list with the wrong width will make the array,
            # an array of lists. The value padding was chosed as [000]
            padding = width - (len(vector) % width)
            vector.extend(padding * ["000"])
            height = int(len(vector) / width)
            array_2D = np.array(vector, dtype=np.float32).reshape((height, width))
            cv.imwrite(path, array_2D)
            completed += size
            done = int(50 * completed / TOTAL_SIZE)

        # Print out updating the user how far along image creating is taking
        sys.stdout.write(
            "\r[{}{}] {}%".format(
                "â–ˆ" * done, "." * (50 - done), int(100 * completed / TOTAL_SIZE)
            )
        )
        sys.stdout.flush()
    sys.stdout.write("\n")
